<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="generator" content="pandoc">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
  <meta name="author" content="Chen Hsong">
  <meta name="dcterms.date" content="2017-01-01">
  <title>iChen Server 4.1 - Store Data to External Database</title>
  <style type="text/css">code{white-space: pre;}</style>
  <style type="text/css">
div.sourceCode { overflow-x: auto; }
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; } /* Keyword */
code > span.dt { color: #902000; } /* DataType */
code > span.dv { color: #40a070; } /* DecVal */
code > span.bn { color: #40a070; } /* BaseN */
code > span.fl { color: #40a070; } /* Float */
code > span.ch { color: #4070a0; } /* Char */
code > span.st { color: #4070a0; } /* String */
code > span.co { color: #60a0b0; font-style: italic; } /* Comment */
code > span.ot { color: #007020; } /* Other */
code > span.al { color: #ff0000; font-weight: bold; } /* Alert */
code > span.fu { color: #06287e; } /* Function */
code > span.er { color: #ff0000; font-weight: bold; } /* Error */
code > span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
code > span.cn { color: #880000; } /* Constant */
code > span.sc { color: #4070a0; } /* SpecialChar */
code > span.vs { color: #4070a0; } /* VerbatimString */
code > span.ss { color: #bb6688; } /* SpecialString */
code > span.im { } /* Import */
code > span.va { color: #19177c; } /* Variable */
code > span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code > span.op { color: #666666; } /* Operator */
code > span.bu { } /* BuiltIn */
code > span.ex { } /* Extension */
code > span.pp { color: #bc7a00; } /* Preprocessor */
code > span.at { color: #7d9029; } /* Attribute */
code > span.do { color: #ba2121; font-style: italic; } /* Documentation */
code > span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code > span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code > span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
  </style>
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
  <link rel="stylesheet" href="../stylesheets/styles.min.css">
</head>
<body>
<header>
<h1 class="title">iChen Server 4.1 - Store Data to External Database</h1>
<p class="author">Chen Hsong</p>
<p class="date">2017</p>
</header>
<section id="ichen-server-4.1-store-data-to-external-database" class="level1">
<h1>iChen<sup>®</sup> Server 4.1 — Store Data to External Database</h1>
<p>Copyright © Chen Hsong Holdings Ltd. All rights reserved.<br />
Document Version: 4.1<br />
Last Edited: 2018-02-09</p>
<section id="introduction" class="level2 prose">
<h2>Introduction</h2>
<p>The iChen<sup>®</sup> Server 4.1 does not provide any data storage out-of-the-box. Users need to employ their own storage mechanism for data archival purposes. Data is usually obtained via either an Open Protocol™ or OPC UA connection.</p>
<p>This design offers tremendous benefits. Not only does it obey the principle of <a href="https://en.wikipedia.org/wiki/Separation_of_concerns"><em>Separation of Concerns (SoC)</em></a>, it helps keep the CPU, memory and hard-disk footprints of the server minimal, allowing it to run on a diverse range of hardware, such as head-less, fan-less mini-PC's with tiny form factor, small solid-state flash storage, weak CPU's and as low as 1GB of RAM. Such a device can practically be deployed <em>anywhere</em> with ease.</p>
<p>Another benefit of this separation of concerns is the (future) ability of the server to run on non-Microsoft Windows<sup>®</sup> operating systems, e.g. Linux.</p>
<p>In addition, the iChen<sup>®</sup> System 4.1 comes standard with <strong>Chen Hsong Cloud</strong> storage capabilities, allowing all data to be seamlessly uploaded to the cloud with no additional requirement other than a connection to the Internet itself (and an storage account ID from Chen Hsong, of course). A full <em>Analytics</em> suite of reports and historical data retrieval download options stands ready to work with data stored in the <strong>Chen Hsong Cloud</strong>.</p>
<p>Still, there are times that enterprise-local data storage is desired, especially where the enterprise already operates in-house database servers or private cloud storage facilities. The iChen<sup>®</sup> Server 4.1 installation program automatically handles the configuration, asking only a few information pieces such as the server name, user name and password etc.</p>
<p>If the database system is very non-standard, so much so that cannot be handled by the installation program, it can still be done manually. This requires minor changes to several configuration files in order to redirect data storage to that external database.</p>
<blockquote>
<p><strong>Note:</strong> Mold data is <em>always</em> stored with the server for integrity purposes, although the user may use the <a href="REST_api_reference.html">REST API</a> to manage stored mold data sets.</p>
</blockquote>
</section>
<section id="supported-databases" class="level2">
<h2>Supported Databases</h2>
<ul>
<li><p>Any database system with an ODBC driver is supported.</p></li>
<li><p>A <em>database creation script</em> is provided for Microsoft SQL Server<sup>®</sup> (including variants such as MSDE, SQL Server<sup>®</sup> Express etc.).</p></li>
<li><p>For other database systems, it is necessary to convert this script to the appropriate format.</p></li>
<li><p>Consult Chen Hsong for help in database script conversion.</p></li>
</ul>
<section id="database-creation-scripts" class="level3">
<h3>Database Creation Scripts</h3>
<table>
<thead>
<tr class="header">
<th>Database System</th>
<th style="text-align: center;">Database Creation Script</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Microsoft SQL Server<sup>®</sup></td>
<td style="text-align: center;"><a href="create_archive_database_sqlserver.sql">Download Script for SQL Server</a></td>
</tr>
<tr class="even">
<td>Microsoft SQL Server<sup>®</sup> Express</td>
<td style="text-align: center;"><a href="create_archive_database_sqlserver.sql">Download Script for SQL Server</a></td>
</tr>
<tr class="odd">
<td>MSDE</td>
<td style="text-align: center;"><a href="create_archive_database_sqlserver.sql">Download Script for SQL Server</a></td>
</tr>
<tr class="even">
<td>MySQL</td>
<td style="text-align: center;"><a href="create_archive_database_mysql.sql">Download Script for MySQL</a></td>
</tr>
<tr class="odd">
<td>PostgreSQL</td>
<td style="text-align: center;"><em>call for support</em></td>
</tr>
<tr class="even">
<td>Oracle</td>
<td style="text-align: center;"><em>call for support</em></td>
</tr>
<tr class="odd">
<td>DB2</td>
<td style="text-align: center;"><em>call for support</em></td>
</tr>
</tbody>
</table>
</section>
</section>
<section id="step-1---create-the-archive-database" class="level2">
<h2>Step 1 - Create the Archive Database</h2>
<section id="important" class="level3 prose">
<h3>Important</h3>
<p>This database must <em>always</em> be created manually, as the installation program does not create any database by itself. It expects the database to already exist.</p>
</section>
<section id="create-the-database" class="level3 prose">
<h3>Create the Database</h3>
<p>In the database server designated for data storage, create a new database (or use an existing one) of any name.</p>
</section>
<section id="database-creation-script" class="level3 prose">
<h3>Database Creation Script</h3>
<p>Download the appropriate <a href="#supported-databases">database creation script</a> and run it to create the necessary tables listed below. Make sure the tables are created inside the appropriate database.</p>
<table>
<thead>
<tr class="header">
<th>Table Name</th>
<th>Data Stored</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>Events</code></td>
<td>All status change data</td>
</tr>
<tr class="even">
<td><code>Alarms</code></td>
<td>All alarms data</td>
</tr>
<tr class="odd">
<td><code>AuditTrail</code></td>
<td>All parameter change records</td>
</tr>
<tr class="even">
<td><code>CycleData</code></td>
<td>All cycle data</td>
</tr>
<tr class="odd">
<td><code>CycleDataValues</code></td>
<td>Cycle data variables and values</td>
</tr>
</tbody>
</table>
</section>
<section id="sql-server-specific" class="level3 prose">
<h3>SQL Server<sup>®</sup> Specific</h3>
<p>In Microsoft SQL Server<sup>®</sup>, make sure that the script is run when the database is the active one. Use the following T-SQL command to change the active database (assuming the database's name is <code>HistoricalDataStorageDB</code>):</p>
<div class="sourceCode"><pre class="sourceCode sql"><code class="sourceCode sql"><span class="kw">USE</span> HistoricalDataStorageDB;
GO</code></pre></div>
<section id="security-considerations-for-sql-server" class="level4 prose">
<h4>Security Considerations for SQL Server<sup>®</sup></h4>
<p>The iChen<sup>®</sup> Server 4.1 must be able to connect to the database via a user account that has permissions to read from and write to those tables. In general, this is usually accomplished by creating a special login exclusively for use by the iChen<sup>®</sup> System 4.1, granting it access to the database as well as the <code>db_datareader</code> and <code>db_datawriter</code> roles.</p>
<p>In some installations, Windows<sup>®</sup>-based or domain-based authorization may be used by the iChen<sup>®</sup> Server 4.1 to connect to the database. In that case, the user account used must still be granted access to the database as well as the <code>db_datareader</code> and <code>db_datawriter</code> roles.</p>
</section>
<section id="option-create-tables-under-custom-schema-in-sql-server" class="level4 prose">
<h4>Option: Create Tables under Custom Schema in SQL Server<sup>®</sup></h4>
<p>When using an existing database for such storage (perhaps to include iChen<sup>®</sup> System 4.1 data together with data from other equipment), it is possible to create the tables under their own <em>schema</em> for better management and security control. For example, running the following <em>before</em> creating the tables will change the <em>default schema</em> of the specified user (in this example, <code>iChenServer</code>) to <code>iChen</code>:</p>
<div class="sourceCode"><pre class="sourceCode sql"><code class="sourceCode sql"><span class="kw">ALTER</span> <span class="fu">USER</span> iChenServer <span class="kw">WITH</span> DEFAULT_SCHEMA = iChen;
GO</code></pre></div>
<p>Needless to say, the schema in question (<code>iChen</code> in the above example) must already exist — it can be created with any database management tool, or the <code>CREATE SCHEMA</code> T-SQL statement.</p>
<p>The user (<code>iChenServer</code> above) must be the user account that is used by the iChen<sup>®</sup> Server 4.1 to connect to the SQL Server<sup>®</sup>.</p>
<p>After changing the default schema of the user, login with the user before running the database creation script. For this to succeed, the user must have <code>CREATE TABLE</code> and associated permissions (such as <code>CREATE INDEX</code>), usually by granting it the <code>db_ddladmin</code> database role.</p>
<p>When the database creation script is run under a user login, and the user has its default schema properly set as well as the necessary permissions to create tables, the tables will then be created under the <code>iChen</code> schema.</p>
<p>After creation of the necessary tables, the role <code>db_ddladmin</code> may be dropped from the user to prevent unauthorized modifications of the table structures.</p>
</section>
</section>
</section>
<section id="step-1b-use-the-installation-program" class="level2 prose">
<h2>Step 1b — Use the Installation Program</h2>
<p>There are no more steps to go. The installation program does all the work automatically. If the iChen<sup>®</sup> System 4.1 has already been installed, it is still possible to add an external data storage database by re-running the installation program and choosing the &quot;Change&quot; option.</p>
</section>
<section id="step-2-edit-the-database-connection-string-manually" class="level2">
<h2>Step 2 — Edit the Database Connection String Manually</h2>
<p>This step, and the steps following, are only for manually configuring an external data storage database.</p>
<p>Open the file <code>iChenServerService.exe.config</code> (within the main iChen<sup>®</sup> System 4.1 folder) and find the following section:</p>
<div class="sourceCode"><pre class="sourceCode xml"><code class="sourceCode xml"><span class="kw">&lt;configuration&gt;</span>
    <span class="kw">&lt;connectionStrings&gt;</span>
        <span class="kw">&lt;add</span><span class="ot"> name=</span><span class="st">&quot;ConfigDB&quot;</span><span class="ot"> connectionString=</span><span class="st">&quot;Data Source=|DataDirectory|\Database\iChenServerDB.sdf&quot;</span><span class="ot"> providerName=</span><span class="st">&quot;System.Data.SqlServerCe.4.1&quot;</span> <span class="kw">/&gt;</span>
        <span class="kw">&lt;add</span><span class="ot"> name=</span><span class="st">&quot;DataArchiveDB&quot;</span><span class="ot"> connectionString=</span><span class="st">&quot;...&quot;</span><span class="ot"> providerName=</span><span class="st">&quot;System.Data.Odbc&quot;</span> <span class="kw">/&gt;</span>
    <span class="kw">&lt;/connectionStrings&gt;</span>

        :
        :
<span class="kw">&lt;/configuration&gt;</span></code></pre></div>
<p>Find the connection string:</p>
<div class="sourceCode"><pre class="sourceCode xml"><code class="sourceCode xml"><span class="kw">&lt;add</span><span class="ot"> name=</span><span class="st">&quot;DataArchiveDB&quot;</span><span class="ot"> connectionString=</span><span class="st">&quot;...&quot;</span><span class="ot"> providerName=</span><span class="st">&quot;System.Data.Odbc&quot;</span> <span class="kw">/&gt;</span></code></pre></div>
<p>For the <code>connectionString</code> attribute, change it to the <em>ODBC connection string</em> to connect to the database. For example, a typical <em>connection string</em> for Microsoft SQL Server<sup>®</sup> should look like (in one single line):</p>
<pre><code>Driver={SQL Server};
    Server=ServerName\SQLSERVER;
    Database=HistoricalDataStorageDB;
    Uid=iChenServer;
    Pwd=ThePassword</code></pre>
<p>Different database systems have different connection string formats. Consult on-line documentation (such as <a href="http://www.connectionstrings.com/">www.connectionstrings.com</a>) to find out the appropriate connection string for the actual database system used.</p>
<p>The final <code>&lt;connectionStrings&gt;</code> section should now look like this (if using SQL Server<sup>®</sup>):</p>
<div class="sourceCode"><pre class="sourceCode xml"><code class="sourceCode xml"><span class="kw">&lt;configuration&gt;</span>
    <span class="kw">&lt;connectionStrings&gt;</span>
        <span class="kw">&lt;add</span><span class="ot"> name=</span><span class="st">&quot;ConfigDB&quot;</span><span class="ot"> connectionString=</span><span class="st">&quot;Data Source=|DataDirectory|\Database\iChenServerDB.sdf&quot;</span><span class="ot"> providerName=</span><span class="st">&quot;System.Data.SqlServerCe.4.1&quot;</span> <span class="kw">/&gt;</span>
        <span class="kw">&lt;add</span><span class="ot"> name=</span><span class="st">&quot;DataArchiveDB&quot;</span><span class="ot"> connectionString=</span><span class="st">&quot;Driver={SQL Server};Server=ServerName\SQLSERVER;Database=HistoricalDataStorageDB;Uid=iChenServer;Pwd=ThePassword&quot;</span><span class="ot"> providerName=</span><span class="st">&quot;System.Data.Odbc&quot;</span> <span class="kw">/&gt;</span>
    <span class="kw">&lt;/connectionStrings&gt;</span>

        :
        :
<span class="kw">&lt;/configuration&gt;</span></code></pre></div>
<p>This allows the iChen<sup>®</sup> Server 4.1 to connect to the database server at the server <code>ServerName</code> and as the user <code>iChenServer</code> with password <code>ThePassword</code>.</p>
<blockquote>
<p><strong>Note:</strong> Do the same for the file <code>iChenConsole.exe.config</code> if <code>iChenConsole.exe</code> will be used.</p>
</blockquote>
</section>
<section id="step-3-specify-database-connection-in-configuration-file-manually" class="level2">
<h2>Step 3 — Specify Database Connection in Configuration File Manually</h2>
<p>Open the file <code>iChenServer.config</code> (within the main iChen<sup>®</sup> System 4.1 folder) and find the following section:</p>
<div class="sourceCode"><pre class="sourceCode xml"><code class="sourceCode xml"><span class="kw">&lt;configuration&gt;</span>
    <span class="kw">&lt;appSettings&gt;</span>
            :
            :
        <span class="kw">&lt;add</span><span class="ot"> key=</span><span class="st">&quot;DataStore&quot;</span> <span class="kw">/&gt;</span>
        <span class="kw">&lt;add</span><span class="ot"> key=</span><span class="st">&quot;CloudStore_Account&quot;</span><span class="ot"> value=</span><span class="st">&quot;ichen&quot;</span> <span class="kw">/&gt;</span>
        <span class="kw">&lt;add</span><span class="ot"> key=</span><span class="st">&quot;CloudStore_Signature&quot;</span><span class="ot"> value=</span><span class="st">&quot; ... &quot;</span> <span class="kw">/&gt;</span>
            :
            :
    <span class="kw">&lt;/appSettings&gt;</span>
<span class="kw">&lt;/configuration&gt;</span></code></pre></div>
<p>The <code>CloudStore</code> keys provision the <strong>Chen Hsong Cloud</strong> storage account <code>ichen</code> for data storage purposes while the <code>DataStore</code> key provisions an external storage database. Change the <code>DataStore</code> key entry to <code>DataArchiveDB</code>:</p>
<div class="sourceCode"><pre class="sourceCode xml"><code class="sourceCode xml"><span class="kw">&lt;configuration&gt;</span>
    <span class="kw">&lt;appSettings&gt;</span>
            :
            :
        <span class="co">&lt;!-- External archive database added --&gt;</span>
        <span class="kw">&lt;add</span><span class="ot"> key=</span><span class="st">&quot;DataStore&quot;</span><span class="ot"> value=</span><span class="st">&quot;DataArchiveDB&quot;</span> <span class="kw">/&gt;</span>

        <span class="co">&lt;!-- Chen Hsong Cloud can be commented out if no longer needed --&gt;</span>
        <span class="co">&lt;!-- or just leave it be; data can be stored in both places simultaneously --&gt;</span>
        <span class="co">&lt;!--add key=&quot;CloudStore_Account&quot; value=&quot;ichen&quot; /--&gt;</span>
        <span class="co">&lt;!--add key=&quot;CloudStore_Signature&quot; value=&quot; ... &quot; /--&gt;</span>
            :
            :
    <span class="kw">&lt;/appSettings&gt;</span>
<span class="kw">&lt;/configuration&gt;</span></code></pre></div>
<p>This provisions the database connection as specified under the name <code>DataArchiveDB</code> (set up in Step 2 above) to be used for storing historical data.</p>
<p>Leaving the <strong>Chen Hsong Cloud</strong> settings intact will upload data for storage on <em>both</em> the cloud as well as the external database:</p>
<div class="sourceCode"><pre class="sourceCode xml"><code class="sourceCode xml"><span class="kw">&lt;configuration&gt;</span>
    <span class="kw">&lt;appSettings&gt;</span>
            :
            :
        <span class="co">&lt;!-- External archive database added --&gt;</span>
        <span class="kw">&lt;add</span><span class="ot"> key=</span><span class="st">&quot;DataStore&quot;</span><span class="ot"> value=</span><span class="st">&quot;DataArchiveDB&quot;</span> <span class="kw">/&gt;</span>

        <span class="co">&lt;!-- Chen Hsong Cloud still used --&gt;</span>
        <span class="kw">&lt;add</span><span class="ot"> key=</span><span class="st">&quot;CloudStore_Account&quot;</span><span class="ot"> value=</span><span class="st">&quot;ichen&quot;</span> <span class="kw">/&gt;</span>
        <span class="kw">&lt;add</span><span class="ot"> key=</span><span class="st">&quot;CloudStore_Signature&quot;</span><span class="ot"> value=</span><span class="st">&quot; ... &quot;</span> <span class="kw">/&gt;</span>
            :
            :
    <span class="kw">&lt;/appSettings&gt;</span>
<span class="kw">&lt;/configuration&gt;</span></code></pre></div>
</section>
<section id="step-4-restart" class="level2 prose">
<h2>Step 4 — Restart</h2>
<p>Restart the iChen<sup>®</sup> Server 4.1 and data should now be stored in the provisioned database server.</p>
<p>The <em>Analytics</em> module, by default, runs off stored data from the database if one is provisioned. If not, it runs off stored data inside the <strong>Chen Hsong Cloud</strong>.</p>
</section>
</section>
<script type="text/javascript" src="/scripts/analytics.min.js"></script>
</body>
</html>
